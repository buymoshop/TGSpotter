<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TGSpotter</title>

<!-- –®—Ä–∏—Ñ—Ç -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Supabase SDK -->
<script src="https://esm.sh/@supabase/supabase-js@2"></script>

<style>
  :root {
    --bg: #f4f6fa;
    --card: #ffffff;
    --accent: #0ea5a4;
    --muted: #6b7280;
  }

  body {
    margin: 0;
    background: var(--bg);
    font-family: "Inter", sans-serif;
  }

  .container {
    max-width: 500px;
    margin: 0 auto;
    padding: 16px;
  }

  .card {
    background: var(--card);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
  }

  .title {
    font-size: 26px;
    font-weight: 700;
    margin-bottom: 10px;
  }

  .subtitle {
    color: var(--muted);
    margin-bottom: 16px;
  }

  input, textarea {
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    border: 1px solid #d1d5db;
    margin-bottom: 14px;
    font-size: 16px;
    outline: none;
  }

  textarea {
    height: 90px;
    resize: none;
  }

  .btn {
    width: 100%;
    padding: 16px;
    background: var(--accent);
    border-radius: 14px;
    border: none;
    color: white;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.2s;
  }

  .btn:active {
    opacity: 0.7;
  }

  .hidden {
    display: none;
  }

  .price {
    font-size: 20px;
    font-weight: 700;
    color: var(--accent);
    margin-bottom: 10px;
  }
</style>
</head>
<body>

<div class="container">

  <div class="card">
    <div class="title">TGSpotter</div>
    <div class="subtitle">–ü—Ä–æ–≤–µ—Ä–∫–∞ Telegram-–∫–∞–Ω–∞–ª–æ–≤ –ø–µ—Ä–µ–¥ –ø–æ–∫—É–ø–∫–æ–π —Ä–µ–∫–ª–∞–º—ã</div>
  </div>

  <div class="card">
    <div class="price">–°—Ç–æ–∏–º–æ—Å—Ç—å: <span id="price">5 EUR</span></div>

    <input id="channel-input" type="text" placeholder="ID –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª">
    <textarea id="notes" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"></textarea>
    <button id="order-btn" class="btn">–ó–∞–∫–∞–∑–∞—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>

    <div id="order-result" style="margin-top:15px; font-size:16px;"></div>
  </div>

  <div class="card">
    <div id="user-status">–ü—Ä–æ–≤–µ—Ä—è—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é...</div>
    <div id="user-detail" style="margin: 6px 0 12px; color: var(--muted)"></div>

    <button id="login-btn" class="btn hidden">–í–æ–π—Ç–∏</button>
    <button id="logout-btn" class="btn hidden" style="background:#ef4444">–í—ã–π—Ç–∏</button>
  </div>

</div>

<script>
/* ===========================
      –ù–ê–°–¢–†–û–ô–ö–ò
=========================== */

const SUPABASE_URL = "https://aidjwvqsfyohbwexkggi.supabase.co";
const SUPABASE_ANON_KEY =
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFpZGp3dnFzZnlvaGJ3ZXhrZ2dpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzU1NzcsImV4cCI6MjA4MDQ1MTU3N30.kwo-cmNzrRX_IKVulAGlrIdSa4uGPnfrudBYs522RxE";

const EDGE_FUNCTION_URL =
  "https://aidjwvqsfyohbwexkggi.supabase.co/functions/v1/log-visit";

const CREATE_ANALYSIS_ENDPOINT = ""; // –ø–æ–∫–∞ –ø—É—Å—Ç–æ

// Supabase client
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Telegram WebApp
const tg = window.Telegram?.WebApp;
if (tg) {
  try { tg.expand(); } catch(e){}
}


/* ===========================
      –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –í–ò–ó–ò–¢–û–í
=========================== */

async function logVisit(eventName, details = {}) {
  try {
    const payload = {
      event: eventName,
      user_id: tg?.initDataUnsafe?.user?.id
        ? "tg:" + tg.initDataUnsafe.user.id
        : "guest",
      details
    };

    await fetch(EDGE_FUNCTION_URL, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });

  } catch (e) {
    console.warn("Visit log error:", e);
  }
}

// üìå –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
logVisit("page_open", { page: "index.html", ts: Date.now() });


/* ===========================
      –≠–õ–ï–ú–ï–ù–¢–´ UI
=========================== */

const loginBtn = document.getElementById("login-btn");
const logoutBtn = document.getElementById("logout-btn");
const userStatus = document.getElementById("user-status");
const userDetail = document.getElementById("user-detail");
const orderBtn = document.getElementById("order-btn");
const channelInput = document.getElementById("channel-input");
const notesInput = document.getElementById("notes");
const orderResult = document.getElementById("order-result");
const priceEl = document.getElementById("price");

const PRICE_EUR = 5.00;
priceEl.textContent = PRICE_EUR.toFixed(2) + " EUR";


/* ===========================
     –ü–†–û–í–ï–†–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò
=========================== */

async function checkSession() {
  const { data } = await supabase.auth.getSession();
  const session = data?.session;

  if (session) return showUser(session.user);

  const tgUser = tg?.initDataUnsafe?.user;
  if (tgUser) {
    userStatus.textContent = "–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω —á–µ—Ä–µ–∑ Telegram";
    userDetail.textContent = `TG ID: ${tgUser.id}`;
    loginBtn.classList.remove("hidden");
    return;
  }

  userStatus.textContent = "–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω—ã";
  loginBtn.classList.remove("hidden");
}

function showUser(user) {
  userStatus.textContent = `–í–æ—à–ª–∏ –∫–∞–∫: ${user.email || user.id}`;
  userDetail.textContent = `UID: ${user.id}`;
  loginBtn.classList.add("hidden");
  logoutBtn.classList.remove("hidden");
}

checkSession();


/* ===========================
        –ó–ê–ö–ê–ó –ê–ù–ê–õ–ò–¢–ò–ö–ò
=========================== */

orderBtn.addEventListener("click", async () => {
  const channel = channelInput.value.trim();
  if (!channel) {
    orderResult.textContent = "–í–≤–µ–¥–∏—Ç–µ ID –∫–∞–Ω–∞–ª–∞!";
    return;
  }

  logVisit("order_click", { channel });

  orderResult.textContent = "–í–∞—à –∑–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!";
});


/* ===========================
          –ö–ù–û–ü–ö–ò –õ–û–ì–ò–ù–ê
=========================== */

loginBtn.addEventListener("click", () => {
  logVisit("login_click");
  alert("–¢—É—Ç —Å–¥–µ–ª–∞–µ–º –æ–∫–Ω–æ –≤—Ö–æ–¥–∞ (–ø–æ–∑–∂–µ)");
});

logoutBtn.addEventListener("click", async () => {
  logVisit("logout");
  await supabase.auth.signOut();
  location.reload();
});
</script>

</body>
</html>
